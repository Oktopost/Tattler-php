!function(){"use strict";function n(n,e){var t=n;for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);return t}function e(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function t(n,e,t,o,r,a){var s=function(n,e){var t,o=[];for(t in n)if(n.hasOwnProperty(t)){var r=e?e+"["+t+"]":t,a=n[t];o.push(null!==a&&"object"==typeof a?s(a,r):encodeURIComponent(r)+"="+encodeURIComponent(a))}return o.join("&")},c=new XMLHttpRequest;if(c.onreadystatechange=function(){c.readyState===XMLHttpRequest.DONE&&(c.status>=200&&c.status<300?("function"==typeof o&&o(JSON.parse(c.responseText)),"function"==typeof a&&a(!0)):("function"==typeof r&&r(c.response),"function"==typeof a&&a(!1)))},"GET"===(n=n.toUpperCase())){var i="?";e.match(/\?/)&&(i="&"),e+=i+s(t),t=""}else t=JSON.stringify(t);return c.open(n,e,!0),c.send(t)}function o(n){for(var e in n)if(n.hasOwnProperty(e))return!1;return JSON.stringify(n)===JSON.stringify({})}function r(n){var e=n.match(/^(wss?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/);return e&&{protocol:e[1],hostname:e[3],port:e[4]}}var a={urls:{ws:"/_tattler/ws",channels:"/_tattler/channels",auth:"/_tattler/auth"},requests:{ws:"get",channels:"get",auth:"get"},readyCallback:!1,readyCallbackOnce:!1,autoConnect:!0,debug:!1},s={},c={getInstance:function(n){return s[n]},create:function(n){var t=new i(n);return s[e()]=t,t}},i=function(e){var s=[],c=n(a,e),i={getWs:{onSuccess:function(n){var e=r(n.ws);l.server=e.protocol+"//"+e.hostname,l.port=e.port,w()},onError:function(){v("error","Failed to get ws address")}},getChannels:{onSuccess:function(n){for(var e in n.channels)n.channels.hasOwnProperty(e)&&d(n.channels[e],!0);i.socket.handleEvents(),"function"==typeof c.readyCallback&&c.readyCallback(),"function"==typeof c.readyCallbackOnce&&(c.readyCallbackOnce(),c.readyCallbackOnce=!1)},onError:function(){v("error","Failed to get channels listing")}},socket:{connected:function(){b(),v("warn","connected to socket")},disconnected:function(){v("error","disconnected from socket");for(var n in l.channels)l.channels.hasOwnProperty(n)&&(l.channels[n]=!1)},handleEvents:function(){void 0===l.socket._callbacks.$defaultEvent&&l.socket.on("defaultEvent",function(n){for(var e=n.id||Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,30),t=n.handler,o=n.namespace||"global",r=0;r<10&&s.hasOwnProperty(r);r++)if(s[r]===e)return void v("info","preventing duplicate message processing",n);s.unshift(e),s.length=10,!1===f(o,t)?v("error","handler "+t+" with namespace "+o+" not defined",n):void 0===n.payload?l.handlers[o][t](n):l.handlers[o][t](n.payload)})}}},l={socket:null,server:null,port:null,channels:{},handlers:{global:{"console.log":function(n){if(void 0!==n.force)return void console.warn(n);!0===c.debug?(v("warn","-------------------------------------------------------------"),v("warn","remote: "+n.message),v("warn","-------------------------------------------------------------")):v("warn","remote",n.message)},alert:function(n){var e;void 0!==n.title&&(e=n.title),""!==e&&(e="--------------------------"+e.toUpperCase()+"--------------------------",e+="\n"),e+=n.message,alert(e)},confirm:function(n){confirm(n.message)?void 0!==n.yes&&"function"==typeof[n.yes]&&n.yes():void 0!==n.no&&"function"==typeof n.no&&window[n.no]()},addChannel:function(n){d(n.channel,!1)},removeChannel:function(n){h(n.channel)}}}},u=[],f=function(n,e){return void 0!==l.handlers[n]&&void 0!==l.handlers[n][e]},d=function(n,e){void 0===l.channels[n]||l.channels[n]!==e?(l.channels[n]=e,null!==l.socket?(v("info","joining channel «"+n+"»"),l.socket.emit("subscribe",n)):v("info","adding channel «"+n+"»")):v("error","channel «"+n+"» already defined")},h=function(n){void 0===l.channels[n]?v("error","failed to unsubscribe from «"+n+"» - channel not defined"):(delete l.channels[n],l.socket.emit("unsubscribe",n),v("warn","unsubscribed from «"+n+"»"))},p=function(n,e,t){"function"==typeof e&&(t=e,e="global"),!1===f(e,n)?(void 0===l.handlers[e]&&(l.handlers[e]={}),l.handlers[e][n]=t,v("info","added handler for event «"+n+"» in namespace «"+e+"»")):v("error","preventing handler creation for event «"+n+"» in «"+e+"»: already exists. Check your code.")},v=function(){for(var n=[],e={},t=0;t<arguments.length;t++)n.push(arguments[t]);var o=n.shift();if(e.type=o,e.date=new Date,e.data=n,u.push(e),!0===c.debug){n.unshift("Tattler:");for(var r in n)if("object"==typeof n[r])return void console[o](n);console[o](n.join(" "))}},g=function(){for(var n in u)console[u[n].type](u[n].date,u[n].data)},y=function(){v("info","requesting WS url"),t(c.requests.ws,c.urls.ws,{},i.getWs.onSuccess,i.getWs.onError)},k=function(n,e){t(c.requests.auth,c.urls.auth,{},function(e){n(e.token)},e)},w=function(){if(null===l.socket){if(null===l.server)return void v("error","Failed to connect to socket: address unknown");k(function(n){l.socket=io(l.server+":"+l.port,{query:"token="+n}),l.socket.on("connect",i.socket.connected),l.socket.on("disconnect",i.socket.disconnected),v("info","connecting to socket at "+l.server+":"+l.port)})}else v("error","socket already connected")},b=function(){var n=l.socket.io.engine.id,e=[];if(o(l.channels))v("log","requesting channels with socketId="+n);else{v("log","connecting to saved channels");for(var r in l.channels)l.channels.hasOwnProperty(r)&&e.push(r)}t(c.requests.channels,c.urls.channels,{socketId:n,channels:e},i.getChannels.onSuccess,i.getChannels.onError)};c.autoConnect&&y(),v("info","creating socket's stuff..."),this.debug=g,this.addHandler=p,this.addChannel=d,this.run=y};window.tattlerFactory=c}();