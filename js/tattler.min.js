!function(){"use strict";function n(n,e){var t=n;for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);return t}function e(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function t(n,e,t,o,r,s){var c=function(n,e){var t,o=[];for(t in n)if(n.hasOwnProperty(t)){var r=e?e+"["+t+"]":t,s=n[t];o.push(null!==s&&"object"==typeof s?c(s,r):encodeURIComponent(r)+"="+encodeURIComponent(s))}return o.join("&")},a=new XMLHttpRequest;if(a.onreadystatechange=function(){a.readyState==XMLHttpRequest.DONE&&(a.status>=200&&a.status<300?("function"==typeof o&&o(JSON.parse(a.responseText)),"function"==typeof s&&s(!0)):("function"==typeof r&&r(a.response),"function"==typeof s&&s(!1)))},n=n.toUpperCase(),"GET"===n){var i="?";e.match(/\?/)&&(i="&"),e+=i+c(t),t=""}else t=JSON.stringify(t);return a.open(n,e,!0),a.send(t)}function o(n){for(var e in n)if(n.hasOwnProperty(e))return!1;return JSON.stringify(n)===JSON.stringify({})}var r={urls:{ws:"/_tattler/ws",channels:"/_tattler/channels"},requests:{ws:"get",channels:"get"},wsPort:{secure:443,notSecure:80},autoConnect:!0,debug:!1},s={},c={getInstance:function(n){return s[n]},create:function(n){var t=new a(n);return s[e()]=t,t}},a=function(e){var s=n(r,e),c={getWs:{onSuccess:function(n){a.ws=n.ws,n.ws.match(/wss/)?a.wsPort=s.wsPort.secure:a.wsPort=s.wsPort.notSecure,g()},onError:function(){h("error","Failed to get ws address")}},getChannels:{onSuccess:function(n){for(var e in n.channels)n.channels.hasOwnProperty(e)&&f(n.channels[e],!0);c.socket.handleEvents()},onError:function(){h("error","Failed to get channels listing")}},socket:{connected:function(){h("warn","connected to socket"),y()},disconnected:function(){h("error","disconnected from socket");for(var n in a.channels)a.channels.hasOwnProperty(n)&&(a.channels[n]=!1)},handleEvents:function(){"undefined"==typeof a.socket._callbacks.$defaultEvent&&a.socket.on("defaultEvent",function(n){var e=n.handler,t=n.namespace||"global";u(t,e)===!1?h("error","handler "+e+" with namespace "+t+" not defined",n):"undefined"==typeof n.payload?a.handlers[t][e](n):a.handlers[t][e](n.payload)})}}},a={socket:null,ws:null,wsPort:null,channels:{},handlers:{global:{"console.log":function(n){return"undefined"!=typeof n.force?void console.warn(n):void(s.debug===!0?(h("warn","-------------------------------------------------------------"),h("warn","remote: "+n.message),h("warn","-------------------------------------------------------------")):h("warn","remote",n.message))},alert:function(n){var e;"undefined"!=typeof n.title&&(e=n.title),""!==e&&(e="--------------------------"+e.toUpperCase()+"--------------------------",e+="\n"),e+=n.message,alert(e)},confirm:function(n){confirm(n.message)?void 0!==n.yes&&"function"==typeof[n.yes]&&n.yes():void 0!==n.no&&"function"==typeof n.no&&window[n.no]()},addChannel:function(n,e){f(n.channel,e)},removeChannel:function(n){l(n.channel)}}}},i=[],u=function(n,e){return"undefined"!=typeof a.handlers[n]&&"undefined"!=typeof a.handlers[n][e]},f=function(n,e){"undefined"==typeof a.channels[n]||a.channels[n]!==e?(a.channels[n]=e,null!==a.socket?(h("info","joining channel «"+n+"»"),a.socket.emit("subscribe",n)):h("info","adding channel «"+n+"»")):h("error","channel «"+n+"» already defined")},l=function(n){"undefined"==typeof a.channels[n]?h("error","failed to unsubscribe from «"+n+"» - channel not defined"):(delete a.channels[n],a.socket.emit("unsubscribe",n),h("warn","unsubscribed from «"+n+"»"))},d=function(n,e,t){"function"==typeof e&&(t=e,e="global"),u(e,n)===!1?("undefined"==typeof a.handlers[e]&&(a.handlers[e]={}),a.handlers[e][n]=t,h("info","added handler for event «"+n+"» in namespace «"+e+"»")):h("error","preventing handler creation for event «"+n+"» in «"+e+"»: already exists. Check your code.")},h=function(){for(var n=[],e={},t=0;t<arguments.length;t++)n.push(arguments[t]);var o=n.shift();if(e.type=o,e.date=new Date,e.data=n,i.push(e),s.debug===!0){n.unshift("Tattler:");for(var r in n)if("object"==typeof n[r])return void console[o](n);console[o](n.join(" "))}},p=function(){for(var n in i)console[i[n].type](i[n].date,i[n].data)},w=function(){h("info","requesting WS url"),t(s.requests.ws,s.urls.ws,{},c.getWs.onSuccess,c.getWs.onError)},g=function(){if(null===a.socket){if(null===a.ws)return void h("error","Failed to connect to socket: address unknown");a.socket=io(a.ws+":"+a.wsPort),a.socket.on("connect",c.socket.connected),a.socket.on("disconnect",c.socket.disconnected),h("info","connecting to socket at "+a.ws+":"+a.wsPort)}else h("error","socket already connected")},y=function(){var n=a.socket.io.engine.id,e=[];if(o(a.channels))h("log","requesting channels with socketId="+n);else{h("log","connecting to saved channels");for(var r in a.channels)a.channels.hasOwnProperty(r)&&e.push(r)}t(s.requests.channels,s.urls.channels,{socketId:n,channels:e},c.getChannels.onSuccess,c.getChannels.onError)};s.autoConnect&&w(),h("info","creating socket's stuff..."),this.debug=p,this.addHandler=d,this.addChannel=f,this.run=w};window.tattlerFactory=c}();