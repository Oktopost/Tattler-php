!function(){"use strict";function n(n,e){var t=n;for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);return t}function e(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function t(n,e,t,o,r,s){var c=function(n,e){var t,o=[];for(t in n)if(n.hasOwnProperty(t)){var r=e?e+"["+t+"]":t,s=n[t];o.push(null!==s&&"object"==typeof s?c(s,r):encodeURIComponent(r)+"="+encodeURIComponent(s))}return o.join("&")},a=new XMLHttpRequest;return a.onreadystatechange=function(){a.readyState==XMLHttpRequest.DONE&&(a.status>=200&&a.status<300?("function"==typeof o&&o(JSON.parse(a.responseText)),"function"==typeof s&&s(!0)):("function"==typeof r&&r(a.response),"function"==typeof s&&s(!1)))},n=n.toUpperCase(),"GET"===n?(e+="?"+c(t),t=""):t=JSON.stringify(t),a.open(n,e,!0),a.send(t)}var o={urls:{ws:"/_tattler/ws",channels:"/_tattler/channels"},requests:{ws:"get",channels:"get"},debug:!1},r={},s={getInstance:function(n){return r[n]},create:function(n){var t=new c(n);return r[e()]=t,t}},c=function(e){var r=n(o,e),s={getWs:{onSuccess:function(n){c.ws=n.ws,h()},onError:function(){l("error","Failed to get ws address")}},getChannels:{onSuccess:function(n){for(var e in n.channels)n.channels.hasOwnProperty(e)&&i(n.channels[e]);s.socket.handleEvents()},onError:function(){l("error","Failed to get channels listing")}},socket:{connected:function(){l("warn","connected to socket"),p()},disconnected:function(){l("error","disconnected from socket");for(var n in c.channels)c.channels.hasOwnProperty(n)&&(c.channels[n]=!1)},handleEvents:function(){"undefined"==typeof c.socket._callbacks.$defaultEvent&&c.socket.on("defaultEvent",function(n){var e=n.handler,t=n.namespace||"global";a(t,e)===!1?l("error","handler "+e+" with namespace "+t+" not defined",n):"undefined"==typeof n.payload?c.handlers[t][e](n):c.handlers[t][e](n.payload)})}}},c={socket:null,ws:null,channels:{},handlers:{global:{"console.log":function(n){return"undefined"!=typeof n.force?void console.warn(n):(l("warn","-------------------------------------------------------------"),l("warn","remote: "+n.message),void l("warn","-------------------------------------------------------------"))},alert:function(n){var e;"undefined"!=typeof n.title&&(e=n.title),""!==e&&(e="--------------------------"+e.toUpperCase()+"--------------------------",e+="\n"),e+=n.message,alert(e)},confirm:function(n){confirm(n.message)?void 0!==n.yes&&"function"==typeof[n.yes]&&n.yes():void 0!==n.no&&"function"==typeof n.no&&window[n.no]()},addChannel:function(n){i(n.channel)},removeChannel:function(n){f(n.channel)}}}},a=function(n,e){return"undefined"!=typeof c.handlers[n]&&"undefined"!=typeof c.handlers[n][e]},i=function(n){"undefined"==typeof c.channels[n]||c.channels[n]===!1?(l("info","joining channel "+n),c.channels[n]=!0,c.socket.emit("subscribe",n)):l("error","channel «"+n+"» already defined")},f=function(n){"undefined"==typeof c.channels[n]?l("error","failed to unsubscribe from «"+n+"» - channel not defined"):(delete c.channels[n],c.socket.emit("unsubscribe",n),l("warn","unsubscribed from «"+n+"»"))},u=function(n,e,t){"function"==typeof e&&(t=e,e="global"),a(e,n)===!1?("undefined"==typeof c.handlers[e]&&(c.handlers[e]={}),c.handlers[e][n]=t,l("info","added handler for event «"+n+"» in namespace «"+e+"»")):l("error","preventing handler creation for event «"+n+"» in «"+e+"»: already exists. Check your code.")},l=function(){for(var n=[],e=0;e<arguments.length;e++)n.push(arguments[e]);var t=n.shift();if(r.debug===!0){n.unshift("Tattler:");for(var o in n)if("object"==typeof n[o])return void console[t](n);console[t](n.join(" "))}},d=function(){l("info","requesting WS url"),t(r.requests.ws,r.urls.ws,{},s.getWs.onSuccess,s.getWs.onError)},h=function(){l("info","connecting to socket at",c.ws),c.socket=io(c.ws),c.socket.on("connect",s.socket.connected),c.socket.on("disconnect",s.socket.disconnected)},p=function(){var n=c.socket.io.engine.id;l("log","requesting channels with socketId="+n),t(r.requests.channels,r.urls.channels,{socketId:n},s.getChannels.onSuccess,s.getChannels.onError)};l("info","creating socket's stuff..."),d(),this.addHandler=u};window.tattlerFactory=s}();